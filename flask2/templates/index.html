{% extends "base.html" %}

{% block sidebar %}
<h4>ğŸ” Search Filters</h4>

<form method="get">

  <!-- Year -->
  <div class="mb-3">
    <label class="form-label">Year</label>
    <input
      list="yearOptions"
      name="year"
      class="form-control"
      placeholder="Type or select year"
      value="{{ selected_year if selected_year!='all' else '' }}"
    />
    <datalist id="yearOptions">
      <option value="all">(All)</option>
      {% for y in years %}
      <option value="{{ y }}">{{ y }}</option>
      {% endfor %}
    </datalist>
  </div>

  <!-- Symbol -->
  <div class="mb-3">
    <label class="form-label">Stock Symbol</label>
    <input
      list="symbolOptions"
      name="symbol"
      class="form-control"
      placeholder="Type or select symbol"
      value="{{ selected_symbol if selected_symbol!='all' else '' }}"
    />
    <datalist id="symbolOptions">
      <option value="all">(All)</option>
      {% for s in symbols %}
      <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
    </datalist>
  </div>

  <!-- Sentiment -->
  <div class="mb-3">
    <label class="form-label">Sentiment Score Range</label>
    <div class="d-flex gap-2">
      <input type="number" name="sent_min" step="any" class="form-control" value="{{ sent_min }}" />
      <input type="number" name="sent_max" step="any" class="form-control" value="{{ sent_max }}" />
    </div>
    <small class="text-muted">Range: {{ min_score|round(2) }} ~ {{ max_score|round(2) }}</small>
  </div>

  <!-- Keyword -->
  <div class="mb-3">
    <label class="form-label">Keyword in Title</label>
    <input type="text" name="keyword" class="form-control" value="{{ keyword }}" />
  </div>

  <!-- news_id -->
  <div class="mb-3">
    <label class="form-label">news_id</label>
    <input type="text" name="news_id" class="form-control" placeholder="Type news_id" value="{{ selected_news_id }}" />
  </div>

  <button class="btn btn-primary w-100">Apply Filters</button>
</form>
{% endblock %}

{% block content %}
<h1 class="mb-3">ğŸ“¡ News Search Engine</h1>
<p style="color:#666;">Explore financial news, trends, and sentiment insights.</p>

<hr />

<!-- Trend -->
<h3>ğŸ“Š Annual Sentiment Trend</h3>
<canvas id="trendChart" height="100"></canvas>

<script>
  new Chart(document.getElementById("trendChart"), {
    type: "line",
    data: {
      labels: {{ trend_years | tojson }},
      datasets: [
        {
          label: "Average Sentiment",
          data: {{ trend_scores | tojson }},
          borderColor: "#2F80ED",
          backgroundColor: "rgba(47,128,237,0.1)",
          tension: 0.3,
          borderWidth: 2
        }
      ]
    }
  });
</script>

<hr />

<h3>{{ summary_title }}</h3>

<div class="row mt-3">
  <div class="col-md-4">
    <div class="metric-box">
      {% if yearly_summary.total_articles > 0 %}
      <h5>Dominant Sentiment</h5>
      <p style="font-size:20px;font-weight:700;color:#2F80ED;">
        {{ yearly_summary.dominant_label | upper }}
      </p>
      <p>{{ yearly_summary.dominant_pct }}% of articles</p>
      <p style="color:#666;">Total: {{ yearly_summary.total_articles }}</p>
      {% else %}
      <p>No data available.</p>
      {% endif %}
    </div>
  </div>

  <div class="col-md-8">
    {% if yearly_summary.summary_rows %}
    <table class="table table-striped table-sm">
      <thead>
        <tr><th>Sentiment</th><th>Count</th><th>Percentage</th></tr>
      </thead>
      <tbody>
        {% for r in yearly_summary.summary_rows %}
        <tr>
          <td>{{ r.Sentiment }}</td>
          <td>{{ r.Count }}</td>
          <td>{{ r.Percentage }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
</div>

<hr />

<h3>ğŸ” Search Results ({{ row_count }} rows)</h3>

<div class="table-responsive" style="max-height:520px; overflow-y:auto;">
  <table class="table table-bordered table-sm table-hover align-middle">
    <thead class="table-light">
      <tr>
        {% for c in table_cols %}
        <th>{{ c }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in table_rows %}
      <tr>
        {% for c in table_cols %}
        <td>{{ r[c] }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<hr />

<h3>ğŸ“° News Detail</h3>

{% if not selected_row %}
<p class="text-muted">Enter a news_id to view article details.</p>
{% else %}
<h4 style="font-weight:700;">{{ selected_row.Article_title }}</h4>

<h5 class="mt-3">ğŸ§  Sentiment</h5>
<ul>
  {% for k in ["sentiment_label","sentiment_score_signed","avg_sentiment_score","pos_ratio","neg_ratio","sentiment_category"] %}
  {% if k in selected_row %}
  <li><b>{{ k }}:</b> {{ selected_row[k] }}</li>
  {% endif %}
  {% endfor %}
</ul>

<h5 class="mt-3">ğŸ“Œ Metadata</h5>
<ul>
  {% for col in ["Year","Date","Stock_symbol","sample_news_id","Publisher","Url","article_count","publisher_count","avg_title_len"] %}
  {% if col in selected_row %}
  <li><b>{{ col }}:</b> {{ selected_row[col] }}</li>
  {% endif %}
  {% endfor %}
</ul>
{% endif %}
{% endblock %}
